<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>秒杀系统——秒杀接口优化 | ckj&#39;s blog</title>
    <meta property="og:title" content="秒杀系统——秒杀接口优化 - ckj&#39;s blog">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-05-06T16:44:34&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-05-06T16:44:34&#43;08:00'>
        
    <meta name="Keywords" content="ckj,java,博客">
    <meta name="description" content="秒杀系统——秒杀接口优化">
        
    <meta name="author" content="ckj">
    <meta property="og:url" content="https://endlesshair.github.io/post/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E7%A7%92%E6%9D%80%E6%8E%A5%E5%8F%A3%E4%BC%98%E5%8C%96/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://endlesshair.github.io/">
                        ckj&#39;s blog
                    </a>
                
                <p class="description">优秀不是目的，更优秀才是。</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://endlesshair.github.io/">首页</a>
                    
                    <a  href="https://endlesshair.github.io/tools/" title="工具">工具</a>
                    
                    <a  href="https://endlesshair.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://endlesshair.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#1秒杀接口优化的思路">1.秒杀接口优化的思路</a></li>
    <li><a href="#2spring-boot-集成-rabbitmq">2.Spring Boot 集成 RabbitMQ</a>
      <ul>
        <li><a href="#21添加依赖和配置">2.1.添加依赖和配置</a></li>
        <li><a href="#22定义配置类创建消息发送者消息接收者">2.2.定义配置类、创建消息发送者、消息接收者</a></li>
      </ul>
    </li>
    <li><a href="#3秒杀接口优化">3.秒杀接口优化</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if(leftPos<220){
                postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">秒杀系统——秒杀接口优化</h1>
        </header>
        <date class="post-meta meta-date">
            2021年5月6日
        </date>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h2 id="1秒杀接口优化的思路">1.秒杀接口优化的思路</h2>
<p>今天主要讲秒杀接口优化，就是对系统中 do_seckill 接口的优化。秒杀接口是系统中的核心接口，这个接口能承受的并发量直接决定了秒杀系统的性能。因为访问数据库是比较耗时的操作，所以秒杀优化的核心思路就是减少数据库的访问，具体思路如下：</p>
<ul>
<li>在系统初始化的时候，把商品库存数量加载到 Redis 缓存中；</li>
<li>收到请求时，Redis 先预减库存，库存不足，直接返回，就不用访问数据库了，否则就进行下面的操作；</li>
<li>上面 Redis 预减判断有库存，就将这个请求加入消息队列中，返回排队中；</li>
<li>请求出队，减库存，生成订单；</li>
<li>前端轮询发起请求，查看是否秒杀成功；</li>
</ul>
<p>既然用到了 RabbitMQ，首先要先安装，然后启动，步骤的话，善于利用搜索引擎嘿嘿！</p>
<h2 id="2spring-boot-集成-rabbitmq">2.Spring Boot 集成 RabbitMQ</h2>
<p>主要步骤如下：</p>
<h3 id="21添加依赖和配置">2.1.添加依赖和配置</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#6272a4">&lt;!--RabbitMQ 依赖，RabbitMQ 是基于AMQP协议的--&gt;</span>
<span style="color:#ff79c6">&lt;dependency&gt;</span>
  <span style="color:#ff79c6">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#ff79c6">&lt;/groupId&gt;</span>
  <span style="color:#ff79c6">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
<span style="color:#ff79c6">&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><pre><code class="language-properties" data-lang="properties">#rabbitmq
spring.rabbitmq.host=47.97.40.86
spring.rabbitmq.port=5672
spring.rabbitmq.username=guest
spring.rabbitmq.password=guest
spring.rabbitmq.virtual-host=/
#消费者数量，1的话就是串行
spring.rabbitmq.listener.simple.concurrency=10
spring.rabbitmq.listener.simple.max-concurrency=10
#连接每次取几个
spring.rabbitmq.listener.simple.prefetch=1
#默认消费者自动启动
spring.rabbitmq.listener.simple.auto-startup=true
#消费者消费失败，数据重新压回来，相当于重试
spring.rabbitmq.listener.simple.default-requeue-rejected= true
#重试的一些参数，根据场景微调
spring.rabbitmq.template.retry.enabled=true 
spring.rabbitmq.template.retry.initial-interval=1000
spring.rabbitmq.template.retry.max-attempts=3
spring.rabbitmq.template.retry.max-interval=10000
spring.rabbitmq.template.retry.multiplier=1.0
</code></pre><p><strong>注意</strong>！上面是用 guest 进行访问的，guest 不能远程连接，只能在本机，所以如果 MQ 不是本机的，要在远程 MQ 根路径的 etc/rabbitmq 目录下面新建如下配置文件：</p>
<p>
        <a data-fancybox="gallery" href="https://img-blog.csdnimg.cn/20210506184024953.png">
            <img class="mx-auto" alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210506184024953.png" />
        </a>
    </p>
<p>并写入：</p>
<p>
        <a data-fancybox="gallery" href="https://img-blog.csdnimg.cn/20210506184110326.png">
            <img class="mx-auto" alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210506184110326.png" />
        </a>
    </p>
<p>随后重启即可。</p>
<h3 id="22定义配置类创建消息发送者消息接收者">2.2.定义配置类、创建消息发送者、消息接收者</h3>
<p>配置类主要定义用到的队列、交换机、绑定规则，因为 RabbitMQ 的 Exchange 有不同绑定队列的模式，对应的发送者和接收者也不一样。最简单的是 direct 模式，直接和队列绑定，常用的还有 topic 和 fanout 模式，他们是将消息先发送给 Exchange 交换机上面，然后由交换机把消息发送到队列中，做了一个路由。</p>
<ol>
<li>
<p><strong>direct模式</strong></p>
<p>direct 模式是直接和队列绑定的，这是最简单的模式。</p>
<p>配置类中：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Configuration
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MQConfig</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">// 队列
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String QUEUE_NAME <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;queue&#34;</span><span style="color:#ff79c6">;</span>
       
    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">    * Direct模式 交换机Exchange，这里默认交换机，@Bean 注解是产生一个队列对象，给spring管理
</span><span style="color:#6272a4">    **/</span>
    @Bean
    <span style="color:#8be9fd;font-style:italic">public</span> Queue <span style="color:#50fa7b">queue</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Queue<span style="color:#ff79c6">(</span>QUEUE_NAME<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>			<span style="color:#6272a4">// 设置队列名称，是否持久化
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>发送者：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Service
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MQSender</span> <span style="color:#ff79c6">{</span>
   <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> Logger log <span style="color:#ff79c6">=</span> LoggerFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getLogger</span><span style="color:#ff79c6">(</span>MQSender<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
   
   <span style="color:#6272a4">//AmqpTemplate 接口定义了发送和接收消息的基本操作
</span><span style="color:#6272a4"></span>   @Autowired
   AmqpTemplate amqpTemplate<span style="color:#ff79c6">;</span>
   
   <span style="color:#6272a4">// direct 发送
</span><span style="color:#6272a4"></span>   <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">send</span><span style="color:#ff79c6">(</span>Object message<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
       String msg <span style="color:#ff79c6">=</span> RedisService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">beanToString</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">);</span>			<span style="color:#6272a4">// 转成 String
</span><span style="color:#6272a4"></span>       log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;send message : &#34;</span> <span style="color:#ff79c6">+</span> msg<span style="color:#ff79c6">);</span>
       amqpTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>MQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">QUEUE_NAME</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">);</span>	<span style="color:#6272a4">// 将消息msg发送到指定队列中
</span><span style="color:#6272a4"></span>   <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>接收者：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Service
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MQReceiver</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> Logger log <span style="color:#ff79c6">=</span> LoggerFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getLogger</span><span style="color:#ff79c6">(</span>MQReceiver<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
   
    <span style="color:#6272a4">// direct 接收，@RabbitListener注解用于监听 queues 中指定的队列
</span><span style="color:#6272a4"></span>    @RabbitListener<span style="color:#ff79c6">(</span>queues <span style="color:#ff79c6">=</span> MQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">QUEUE_NAME</span><span style="color:#ff79c6">)</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">receive</span><span style="color:#ff79c6">(</span>String message<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;receive message : &#34;</span> <span style="color:#ff79c6">+</span> message<span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在 TestController 中测试及结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    @RequestMapping<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;mq&#34;</span><span style="color:#ff79c6">)</span>
    @ResponseBody
    <span style="color:#8be9fd;font-style:italic">public</span> Result<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">mq</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        sender<span style="color:#ff79c6">.</span><span style="color:#50fa7b">send</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;hello,ckj&#34;</span><span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">return</span> Result<span style="color:#ff79c6">.</span><span style="color:#50fa7b">success</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Hello，world&#34;</span><span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>
        <a data-fancybox="gallery" href="https://img-blog.csdnimg.cn/20210506184412917.png">
            <img class="mx-auto" alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210506184412917.png" />
        </a>
    </p>
</li>
<li>
<p><strong>topic 模式</strong></p>
<p>可以理解为通配符匹配模式，看示例就知道了。</p>
<p>配置类中：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Configuration
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MQConfig</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">// 队列
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String QUEUE_NAME <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;queue&#34;</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String TOPIC_QUEUE1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;topic.queue1&#34;</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String TOPIC_QUEUE2 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;topic.queue2&#34;</span><span style="color:#ff79c6">;</span>
   
    <span style="color:#6272a4">// 交换机
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String TOPIC_EXCHANGE <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;topicExchange&#34;</span><span style="color:#ff79c6">;</span>
       
    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">    * Topic模式，这里需要创建队列，交换机，以及他们之间的BindingKey，*代表一个单词，#代表0个或多个单词
</span><span style="color:#6272a4">    **/</span>
    @Bean
    <span style="color:#8be9fd;font-style:italic">public</span> Queue <span style="color:#50fa7b">topicQueue1</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Queue<span style="color:#ff79c6">(</span>TOPIC_QUEUE1<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>
    @Bean
    <span style="color:#8be9fd;font-style:italic">public</span> Queue <span style="color:#50fa7b">topicQueue2</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Queue<span style="color:#ff79c6">(</span>TOPIC_QUEUE2<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>
    @Bean
    <span style="color:#8be9fd;font-style:italic">public</span> TopicExchange <span style="color:#50fa7b">topicExchange</span><span style="color:#ff79c6">(){</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> TopicExchange<span style="color:#ff79c6">(</span>TOPIC_EXCHANGE<span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>
    @Bean
    <span style="color:#8be9fd;font-style:italic">public</span> Binding <span style="color:#50fa7b">topicBinding1</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> BindingBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>topicQueue1<span style="color:#ff79c6">()).</span><span style="color:#50fa7b">to</span><span style="color:#ff79c6">(</span>topicExchange<span style="color:#ff79c6">()).</span><span style="color:#50fa7b">with</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;topic.key1&#34;</span><span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>
    @Bean
    <span style="color:#8be9fd;font-style:italic">public</span> Binding <span style="color:#50fa7b">topicBinding2</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> BindingBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>topicQueue2<span style="color:#ff79c6">()).</span><span style="color:#50fa7b">to</span><span style="color:#ff79c6">(</span>topicExchange<span style="color:#ff79c6">()).</span><span style="color:#50fa7b">with</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;topic.#&#34;</span><span style="color:#ff79c6">);</span>   <span style="color:#6272a4">// topic 模式支持通配符
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>发送者：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#6272a4">// topic 发送，发送两个消息，第一个消息，两个队列都能收到，第二个消息，只有第二个队列能收到
</span><span style="color:#6272a4"></span> <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">sendTopic</span><span style="color:#ff79c6">(</span>Object message<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
     String msg <span style="color:#ff79c6">=</span> RedisService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">beanToString</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">);</span>
     log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;send topic message : &#34;</span> <span style="color:#ff79c6">+</span> msg<span style="color:#ff79c6">);</span>
     amqpTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>MQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">TOPIC_EXCHANGE</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;topic.key1&#34;</span><span style="color:#ff79c6">,</span> msg <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;1&#34;</span><span style="color:#ff79c6">);</span>
     amqpTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>MQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">TOPIC_EXCHANGE</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;topic.key2&#34;</span><span style="color:#ff79c6">,</span> msg <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;2&#34;</span><span style="color:#ff79c6">);</span>
 <span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>接收者：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#6272a4">// topic 接收，分别监听队列1和队列2
</span><span style="color:#6272a4"></span> @RabbitListener<span style="color:#ff79c6">(</span>queues <span style="color:#ff79c6">=</span> MQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">TOPIC_QUEUE1</span><span style="color:#ff79c6">)</span>
 <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">receiveTopic1</span><span style="color:#ff79c6">(</span>String message<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
     log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;topic queue1 message : &#34;</span> <span style="color:#ff79c6">+</span> message<span style="color:#ff79c6">);</span>
 <span style="color:#ff79c6">}</span>
 @RabbitListener<span style="color:#ff79c6">(</span>queues <span style="color:#ff79c6">=</span> MQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">TOPIC_QUEUE2</span><span style="color:#ff79c6">)</span>
 <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">receiveTopic2</span><span style="color:#ff79c6">(</span>String message<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
     log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;topic queue2 message : &#34;</span> <span style="color:#ff79c6">+</span> message<span style="color:#ff79c6">);</span>
 <span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>测试结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    @RequestMapping<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;mq/topic&#34;</span><span style="color:#ff79c6">)</span>
    @ResponseBody
    <span style="color:#8be9fd;font-style:italic">public</span> Result<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">topic</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        sender<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sendTopic</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;hello,ckj&#34;</span><span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">return</span> Result<span style="color:#ff79c6">.</span><span style="color:#50fa7b">success</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Hello，world&#34;</span><span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>
        <a data-fancybox="gallery" href="https://img-blog.csdnimg.cn/2021050619002272.png">
            <img class="mx-auto" alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2021050619002272.png" />
        </a>
    </p>
<p>结果当然是，消息1可以发送到队列1、队列2，消息2只能发送到队列2。</p>
</li>
<li>
<p><strong>fanout 模式</strong></p>
<p>fanout 模式类似于广播，它会将消息推送到所有队列。</p>
<p>配置类中，我们还是用上面 topic 的队列。交换机和绑定需要新建：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#6272a4">// 交换机
</span><span style="color:#6272a4"></span> <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String FANOUT_EXCHANGE <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;fanoutExchange&#34;</span><span style="color:#ff79c6">;</span>
   
 <span style="color:#6272a4">/**
</span><span style="color:#6272a4">  * Fanout模式 交换机Exchange，广播模式，不需要key
</span><span style="color:#6272a4">  * */</span>
 @Bean
 <span style="color:#8be9fd;font-style:italic">public</span> FanoutExchange <span style="color:#50fa7b">fanoutExchange</span><span style="color:#ff79c6">(){</span>
     <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> FanoutExchange<span style="color:#ff79c6">(</span>FANOUT_EXCHANGE<span style="color:#ff79c6">);</span>
 <span style="color:#ff79c6">}</span>
 @Bean
 <span style="color:#8be9fd;font-style:italic">public</span> Binding <span style="color:#50fa7b">FanoutBinding1</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
     <span style="color:#ff79c6">return</span> BindingBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>topicQueue1<span style="color:#ff79c6">()).</span><span style="color:#50fa7b">to</span><span style="color:#ff79c6">(</span>fanoutExchange<span style="color:#ff79c6">());</span>
 <span style="color:#ff79c6">}</span>
 @Bean
 <span style="color:#8be9fd;font-style:italic">public</span> Binding <span style="color:#50fa7b">FanoutBinding2</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
     <span style="color:#ff79c6">return</span> BindingBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>topicQueue2<span style="color:#ff79c6">()).</span><span style="color:#50fa7b">to</span><span style="color:#ff79c6">(</span>fanoutExchange<span style="color:#ff79c6">());</span>
 <span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>发送者：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#6272a4">// fanout
</span><span style="color:#6272a4"></span> <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">sendFanout</span><span style="color:#ff79c6">(</span>Object message<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
     String msg <span style="color:#ff79c6">=</span> RedisService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">beanToString</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">);</span>
     log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;send fanout message : &#34;</span> <span style="color:#ff79c6">+</span> msg<span style="color:#ff79c6">);</span>
     amqpTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>MQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">FANOUT_EXCHANGE</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">);</span>
 <span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>接收者还是用 topic 的。</p>
<p>测试以及结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    @RequestMapping<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;mq/fanout&#34;</span><span style="color:#ff79c6">)</span>
    @ResponseBody
    <span style="color:#8be9fd;font-style:italic">public</span> Result<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">fanout</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        sender<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sendFanout</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;hello,ckj&#34;</span><span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">return</span> Result<span style="color:#ff79c6">.</span><span style="color:#50fa7b">success</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Hello，world&#34;</span><span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>
        <a data-fancybox="gallery" href="https://img-blog.csdnimg.cn/20210506190715652.png">
            <img class="mx-auto" alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210506190715652.png" />
        </a>
    </p>
</li>
</ol>
<p>至此，RabbitMQ 差不多就准备好了。下面就用这个来对秒杀接口进行优化，看看能用在什么地方。</p>
<h2 id="3秒杀接口优化">3.秒杀接口优化</h2>
<p>根据第1部分的思路来。</p>
<ol>
<li>
<p>首先，预加载商品库存到 Redis 中。SeckillController 实现 InitializingBean 接口，重写 afterPropertiesSet 方法，这个方法会在初始化的时候调用。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#6272a4">// 实现了 InitializingBean 接口重写的方法，系统启动的时候，就将数据存入Redis
</span><span style="color:#6272a4"></span>    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">afterPropertiesSet</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//加载所有秒杀商品
</span><span style="color:#6272a4"></span>        List<span style="color:#ff79c6">&lt;</span>GoodsVo<span style="color:#ff79c6">&gt;</span> goodsList <span style="color:#ff79c6">=</span> goodsService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">listGoodsVo</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>goodsList <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>    <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
   
        <span style="color:#6272a4">//存入Redis中，各秒杀商品的数量
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>GoodsVo goods <span style="color:#ff79c6">:</span> goodsList<span style="color:#ff79c6">){</span>
            redisService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>GoodsKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">seckillGoodsStock</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;&#34;</span> <span style="color:#ff79c6">+</span> goods<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getId</span><span style="color:#ff79c6">(),</span> goods<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getStockCount</span><span style="color:#ff79c6">());</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在秒杀操作进行的时候，就可以先查询 Redis 缓存，进行预减，判断是否还有库存，就不用查数据库来判断了。如果没有库存，直接返回，如果还有库存，再判断是否已经秒杀到了，如果还能往下走，那就可以进行秒杀，将请求加入消息队列。</p>
<p>
        <a data-fancybox="gallery" href="https://img-blog.csdnimg.cn/20210506191610360.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70">
            <img class="mx-auto" alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210506191610360.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70" />
        </a>
    </p>
</li>
<li>
<p>有库存，没秒杀过，封装秒杀消息，包含商品 id 和 user，将秒杀消息发送到队列。</p>
<p>配置类中这里直接用 direct 模式，新建秒杀队列。发送者如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#6272a4">// 秒杀
</span><span style="color:#6272a4"></span> <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">sendSeckillMessage</span><span style="color:#ff79c6">(</span>SeckillMessage sm<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
     String msg <span style="color:#ff79c6">=</span> RedisService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">beanToString</span><span style="color:#ff79c6">(</span>sm<span style="color:#ff79c6">);</span>
     log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;send seckill message : &#34;</span> <span style="color:#ff79c6">+</span> msg<span style="color:#ff79c6">);</span>
     amqpTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>MQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">SECKILL_QUEUE</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">);</span>
 <span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>秒杀消息入队：</p>
<p>
        <a data-fancybox="gallery" href="https://img-blog.csdnimg.cn/20210506192042254.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70">
            <img class="mx-auto" alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210506192042254.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70" />
        </a>
    </p>
</li>
<li>
<p>请求出队，接收者消费消息，这里就是在接收者中进行秒杀业务操作：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">     @RabbitListener<span style="color:#ff79c6">(</span>queues <span style="color:#ff79c6">=</span> MQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">SECKILL_QUEUE</span><span style="color:#ff79c6">)</span>
     <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">receive</span><span style="color:#ff79c6">(</span>String message<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
         log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">info</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;receive seckill message : &#34;</span> <span style="color:#ff79c6">+</span> message<span style="color:#ff79c6">);</span>
         SeckillMessage sm  <span style="color:#ff79c6">=</span> RedisService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">stringToBean</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">,</span> SeckillMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
         SeckillUser user <span style="color:#ff79c6">=</span> sm<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUser</span><span style="color:#ff79c6">();</span>
         <span style="color:#8be9fd">long</span> goodsId <span style="color:#ff79c6">=</span> sm<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGoodsId</span><span style="color:#ff79c6">();</span>
      
         <span style="color:#6272a4">// 判断库存
</span><span style="color:#6272a4"></span>         GoodsVo goods <span style="color:#ff79c6">=</span> goodsService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGoodsVoByGoodsId</span><span style="color:#ff79c6">(</span>goodsId<span style="color:#ff79c6">);</span>
         <span style="color:#8be9fd">int</span> stock <span style="color:#ff79c6">=</span> goods<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getStockCount</span><span style="color:#ff79c6">();</span>
         <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>stock <span style="color:#ff79c6">&lt;=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
             <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
         <span style="color:#ff79c6">}</span>
         <span style="color:#6272a4">//判断是否已经秒杀过了
</span><span style="color:#6272a4"></span>         SeckillOrder order <span style="color:#ff79c6">=</span> orderService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSeckillOrderByUserIdGoodsId</span><span style="color:#ff79c6">(</span>user<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getId</span><span style="color:#ff79c6">(),</span> goodsId<span style="color:#ff79c6">);</span>
         <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>order <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
             <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
         <span style="color:#ff79c6">}</span>
         <span style="color:#6272a4">//有库存，没秒杀过，开始减库存 下订单
</span><span style="color:#6272a4"></span>         seckillService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">seckill</span><span style="color:#ff79c6">(</span>user<span style="color:#ff79c6">,</span> goods<span style="color:#ff79c6">);</span>
     <span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>前端进行轮询，查询秒杀结果</p>
<p>下面就是让前端做轮询操作。当秒杀返回 0，代表排队中，此时应该去发起轮询请求。</p>
<p>
        <a data-fancybox="gallery" href="https://img-blog.csdnimg.cn/20210506193006341.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70">
            <img class="mx-auto" alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210506193006341.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70" />
        </a>
    </p>
<p>轮询查询结果成功时，判断返回的数据部分，是数字几：</p>
<p>
        <a data-fancybox="gallery" href="https://img-blog.csdnimg.cn/20210506193204814.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70">
            <img class="mx-auto" alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210506193204814.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70" />
        </a>
    </p>
<p>此时，后端也是需要一个查询结果的接口的：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#6272a4">/**返回：
</span><span style="color:#6272a4">     * orderId：成功
</span><span style="color:#6272a4">     * -1：秒杀失败
</span><span style="color:#6272a4">     * 0： 排队中
</span><span style="color:#6272a4">     * */</span>
    @RequestMapping<span style="color:#ff79c6">(</span>value <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;result&#34;</span><span style="color:#ff79c6">,</span> method <span style="color:#ff79c6">=</span> RequestMethod<span style="color:#ff79c6">.</span><span style="color:#50fa7b">GET</span><span style="color:#ff79c6">)</span>
    @ResponseBody
    <span style="color:#8be9fd;font-style:italic">public</span> Result<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">seckillResult</span><span style="color:#ff79c6">(</span>Model model<span style="color:#ff79c6">,</span> SeckillUser user<span style="color:#ff79c6">,</span> @RequestParam<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;goodsId&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd">long</span> goodsId<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        model<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addAttribute</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;user&#34;</span><span style="color:#ff79c6">,</span> user<span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>user <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">return</span> Result<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span>CodeMsg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">SESSION_ERROR</span><span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>goodsId <span style="color:#ff79c6">&lt;=</span> 0<span style="color:#ff79c6">){</span>
            <span style="color:#ff79c6">return</span> Result<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span>CodeMsg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">GOODS_NOT_EXIST</span><span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#8be9fd">long</span> result <span style="color:#ff79c6">=</span> seckillService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSeckillResult</span><span style="color:#ff79c6">(</span>user<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getId</span><span style="color:#ff79c6">(),</span> goodsId<span style="color:#ff79c6">);</span>  <span style="color:#6272a4">// 如果成功，返回订单id
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">return</span> Result<span style="color:#ff79c6">.</span><span style="color:#50fa7b">success</span><span style="color:#ff79c6">(</span>result<span style="color:#ff79c6">);</span>
    <span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>到这里，此时应该差不多了。但是仔细想想下面的部分代码：</p>
<p>
        <a data-fancybox="gallery" href="https://img-blog.csdnimg.cn/20210506200139322.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70">
            <img class="mx-auto" alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210506200139322.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70" />
        </a>
    </p>
<p>如果有 10 个库存，前面 10 个请求已经将 stock 变成 0 了，当第 11 个请求过来时，stock 变成 -1，当第 12 个请求过来时，stock 变为 -2，啥意思？这里就是说，当库存变为负数时，后面还要去减，是没必要的，连 redis 访问也没必要了。那这里应该怎么办呢？</p>
<p><strong>答案是做内存标记。</strong></p>
<p>我们设置一个 map 集合，里面存放的是（商品 id——flase）键值对，代表那个商品没有秒杀完。在系统初始化的时候，存入这个 map。</p>
<p>
        <a data-fancybox="gallery" href="https://img-blog.csdnimg.cn/20210506194112170.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70">
            <img class="mx-auto" alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210506194112170.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70" />
        </a>
    </p>
<p>当 Redis 预减库存后，发现库存是负数了，就可以把 map 集合中对应商品 value 值设置为 true，表示这个商品已经秒杀完。</p>
<p>
        <a data-fancybox="gallery" href="https://img-blog.csdnimg.cn/20210506194754149.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70">
            <img class="mx-auto" alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210506194754149.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI5MjA1MA==,size_16,color_FFFFFF,t_70" />
        </a>
    </p>
<p>这样，第 12 个以及后面的请求，连 redis 也不会访问了。又省一大堆事了！</p>
</li>
</ol>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E9%A1%B5%E9%9D%A2%E4%BC%98%E5%8C%96/">秒杀系统——页面优化</a></li>
        
        <li><a href="/post/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E5%88%86%E5%B8%83%E5%BC%8FSession/">秒杀系统——分布式Session</a></li>
        
        <li><a href="/post/hugo&#43;GitHub%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/">Hugo&#43;GitHub搭建个人博客</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            没有标签
            
        </div>
    </article>
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "ckj" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="https://endlesshair.github.io/">ckj&#39;s blog By ckj</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'GA ID', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://endlesshair.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://endlesshair.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://endlesshair.github.io/post/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E7%A7%92%E6%9D%80%E6%8E%A5%E5%8F%A3%E4%BC%98%E5%8C%96/" title="秒杀系统——秒杀接口优化">秒杀系统——秒杀接口优化</a>
    </li>
    
    <li>
        <a href="https://endlesshair.github.io/post/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E9%A1%B5%E9%9D%A2%E4%BC%98%E5%8C%96/" title="秒杀系统——页面优化">秒杀系统——页面优化</a>
    </li>
    
    <li>
        <a href="https://endlesshair.github.io/post/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E5%88%86%E5%B8%83%E5%BC%8FSession/" title="秒杀系统——分布式Session">秒杀系统——分布式Session</a>
    </li>
    
    <li>
        <a href="https://endlesshair.github.io/post/hugo&#43;GitHub%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/" title="Hugo&#43;GitHub搭建个人博客">Hugo&#43;GitHub搭建个人博客</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://blog.csdn.net/weixin_44292050?spm=1011.2124.3001.5343" title="我的 CSDN">我的 CSDN</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://endlesshair.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>